# üî• Firebase Security Rules Update Required

## ‚ö†Ô∏è IMPORTANT: Deploy Updated Firestore Rules

The app now requires updated Firestore security rules to function properly. Follow these steps:

## Step 1: Go to Firebase Console

Visit: https://console.firebase.google.com/project/connectrockin/firestore/rules

## Step 2: Replace Existing Rules

Copy the entire content from `firestore.rules` file in this repository and paste it into the Firebase Console Rules editor.

The new rules include permissions for:
- ‚úÖ `places` - Public read, authenticated write
- ‚úÖ `moderation_queue` - Authenticated users only
- ‚úÖ `reviews` - Public read, authenticated write
- ‚úÖ **`user_profiles`** - Users can manage their own profiles (NEW)
- ‚úÖ **`taste_profiles`** - Users can manage their own taste profiles (NEW)
- ‚úÖ **`user_onboarding_events`** - Users can only access their own data (NEW)
- ‚úÖ **`friend_requests`** - Users can manage their own friend requests (NEW)
- ‚úÖ `admin_roles` - Read-only for admin checks

## Step 3: Publish the Rules

Click the **"Publish"** button in the Firebase Console to deploy the new rules.

## Step 4: Verify Rules are Active

After publishing, you should see:
```
Last published: Just now
```

---

## üîÑ Updated Authentication Flow

### New Flow (Current Implementation):

1. **User Signs In** (Google/Email)
   - `useAuthProfileSetup` hook listens to auth state
   - Automatically creates **minimal profile** in `user_profiles` collection
   - Profile includes: `hasCompletedOnboarding: false`

2. **User Redirected to Onboarding**
   - **Sheet 0**: User selects username, display name, and avatar emoji
   - **Sheets 1-4**: User completes taste profile questions
   - Gemini 2.0 Flash analyzes responses and generates taste profile

3. **Onboarding Completion**
   - Taste profile saved to `taste_profiles` collection
   - User profile **updated** (not created) with:
     - `username`, `displayName`, `avatarEmoji`
     - `tasteProfileId` (reference to taste profile)
     - `hasCompletedOnboarding: true`
     - Privacy settings from Sheet 4

4. **User Can Access Full App**
   - Profile page shows all XP, levels, achievements
   - All data fetched from `user_profiles` collection
   - Map and other features now accessible

### Benefits:

- ‚úÖ **No Permission Errors**: Profile exists immediately after sign-in
- ‚úÖ **Progressive Data Collection**: Minimal profile ‚Üí Complete profile
- ‚úÖ **Gemini Integration**: Taste profile only created after full onboarding
- ‚úÖ **Proper Data Flow**: All user data fetched from database, not auth object

---

## üóÑÔ∏è Database Collections Structure

### `user_profiles/{userId}`
Created: **Immediately after authentication**
```javascript
{
  uid: string,
  email: string,
  displayName: string | null,        // Set during onboarding
  photoURL: string | null,
  avatarEmoji: string | null,         // Set during onboarding
  username: string | null,            // Set during onboarding
  bio: string,
  hasCompletedOnboarding: boolean,    // false ‚Üí true after onboarding
  tasteProfileId: string | null,      // Set during onboarding
  xp: 0,
  level: 1,
  // ... other fields initialized to defaults
}
```

### `taste_profiles/{profileId}`
Created: **During onboarding completion**
```javascript
{
  userId: string,
  persona: string,                    // Generated by Gemini
  personaLabel: string,
  vector: number[],                   // Taste vector from Gemini
  tags: string[],
  explanation: string,                // Gemini's analysis
  refinedDescription: string,
  // ... other taste profile fields
}
```

### `user_onboarding_events/{userId}/responses/{responseId}`
Created: **During onboarding process**
```javascript
{
  userId: string,
  sheet1: object,                     // Persona selection
  sheet2: object,                     // Food preferences
  sheet3: object,                     // Discovery preferences
  sheet4: object,                     // Privacy settings
  processed: boolean,
  profileId: string,
  createdAt: timestamp
}
```

---

## üîç Testing the New Flow

1. **Delete your test user account** from Firebase Authentication
2. **Clear Firestore** `user_profiles` document for that user
3. **Sign in with Google** again
4. **Check Console Logs**:
   - Should see: "üÜï New user detected, creating minimal profile..."
   - Should see: "‚úÖ Minimal profile created successfully"
5. **Complete Onboarding**:
   - Enter username and display name
   - Complete all 5 onboarding sheets
   - Wait for Gemini to generate taste profile
6. **Verify Database**:
   - `user_profiles/{uid}` should have `hasCompletedOnboarding: true`
   - `taste_profiles/{id}` should exist
   - Profile page should display all data correctly

---

## üö® Common Issues

### "Missing or insufficient permissions"
- **Cause**: Firestore rules not updated
- **Fix**: Deploy the new rules from `firestore.rules` to Firebase Console

### "Profile not found after sign-in"
- **Cause**: `useAuthProfileSetup` hook not running
- **Fix**: Ensure `App.tsx` includes the hook: `useAuthProfileSetup()`

### "Onboarding doesn't update username"
- **Cause**: Old code using `setDoc` instead of `updateDoc`
- **Fix**: Verify `OnboardingPage.tsx` uses `updateDoc` to update existing profile

### "XP/Levels showing as undefined"
- **Cause**: Fields not initialized in minimal profile
- **Fix**: Check `useAuthProfileSetup.ts` initializes all fields with defaults

---

## üìù Summary

The updated implementation ensures:

1. ‚úÖ **Minimal profile created immediately** after authentication
2. ‚úÖ **No Firestore permission errors** during onboarding
3. ‚úÖ **All data fetched from database**, not auth object
4. ‚úÖ **Gemini integration** only runs during onboarding completion
5. ‚úÖ **Progressive profile completion** with proper data flow

**Next Step**: Deploy the Firestore rules and test the flow!
